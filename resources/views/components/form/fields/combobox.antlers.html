{{ once }}
    {{ push:scripts }}
        {{ vite src="resources/js/combobox.js" }}
    {{ /push:scripts }}
{{ /once }}

<div
    x-data="combobox({
        id: '{{ handle }}',
        items: {{ options | to_js }},
        value: '{{ old_value ?? value }}',
        placeholder: '{{ placeholder ?? 'Select a value...' }}'
    })"
    @keydown.escape.stop.prevent="closeListbox()"
    class="relative"
    {{ attributes }}
>
    <input type="hidden" name="{{ handle }}" x-model="value">

    <button
        @click="toggleListbox()"
        type="button"
        class="relative w-full cursor-default rounded-md bg-white py-2 pl-3 pr-10 text-left shadow-sm ring-1 ring-inset ring-gray-300 focus:outline-none focus:ring-2 focus:ring-primary-600 sm:text-sm sm:leading-6"
        :aria-expanded="listboxOpen"
        aria-haspopup="listbox"
    >
        <span class="block truncate" x-text="buttonLabel"></span>
        <span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-2">
            {{ svg src="heroicons-mini/chevron-up-down" class="size-5 text-gray-400" }}
        </span>
    </button>

    <div
        x-show="listboxOpen"
        x-cloak
        @click.away="closeListbox()"
        x-transition:enter="transition ease-out duration-100"
        x-transition:enter-start="opacity-0 scale-95"
        x-transition:enter-end="opacity-100 scale-100"
        x-transition:leave="transition ease-in duration-75"
        x-transition:leave-start="opacity-100 scale-100"
        x-transition:leave-end="opacity-0 scale-95"
        class="absolute z-10 mt-1 w-full bg-white shadow-lg rounded-md ring-1 ring-black ring-opacity-5 origin-top"
    >
        <div class="p-1">
            <input
                x-ref="comboboxInput"
                x-model.debounce.100ms="comboboxSearch"
                type="text"
                placeholder="Search..."
                class="w-full rounded-md border-0 bg-white px-2 py-1.5 text-gray-900 ring-1 ring-inset ring-gray-200 focus:ring-2 focus:ring-inset focus:ring-primary-600 sm:text-sm"
                role="combobox"
                :aria-controls="`${id}-items`"
                :aria-expanded="listboxOpen"
                autocomplete="off"
                autocorrect="off"
                spellcheck="false"
                @keydown.enter.stop.prevent="selectOption()"
                @keydown.arrow-up.prevent="navigate('previous')"
                @keydown.arrow-down.prevent="navigate('next')"
            >
        </div>

        <ul
            x-ref="listbox"
            :id="`${id}-items`"
            class="max-h-60 overflow-auto py-1 text-base ring-1 ring-black ring-opacity-5 focus:outline-none sm:text-sm"
            role="listbox"
        >
            <template x-for="(item, index) in itemsShown" :key="`item-${index}`">
                <li
                    :id="`${id}-option-${item.key}`"
                    role="option"
                    :aria-selected="itemIsSelected(item)"
                    class="relative cursor-default select-none py-2 pl-3 pr-9"
                    :class="{ 'bg-primary-600 text-white': itemIsActive(item), 'text-gray-900': !itemIsActive(item) }"
                    @click="selectOption(item)"
                    @mousemove="setActiveItem(item)"
                >
                    <span class="block truncate" :class="{ 'font-semibold': itemIsSelected(item) }" x-text="item.value"></span>
                    <span
                        x-show="itemIsSelected(item)"
                        class="absolute inset-y-0 right-0 flex items-center pr-4"
                        :class="{ 'text-white': itemIsActive(item), 'text-primary-600': !itemIsActive(item) }"
                    >
                        {{ svg src="heroicons-mini/check" class="h-5 w-5" }}
                    </span>
                </li>
            </template>

            <li x-show="itemsFiltered.length > itemsLoaded" x-intersect="loadMoreItems()" class="p-2 text-center text-xs text-gray-400">Loading more...</li>

            <li
                x-show="!itemsFiltered.length"
                x-text="emptyOptionsMessage"
                class="relative cursor-default select-none py-2 px-3 text-gray-700"
            ></li>
        </ul>
    </div>
</div>
